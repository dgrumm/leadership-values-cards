# Feature Spec: 03.1 - Drag Drop Mechanics

## Overview
Smooth, responsive drag-and-drop system for card sorting with snap-to-pile behavior and visual feedback.

## User Story
As a participant, I can drag cards naturally with immediate visual feedback and reliable snap-to-pile behavior.

## Technical Requirements

### Drag Implementation
- [ ] Use @dnd-kit/sortable for robust drag-and-drop
- [ ] Support both mouse and touch interactions
- [ ] Card follows cursor/finger with minimal lag (<16ms)
- [ ] Ghost image shows during drag with 0.7 opacity
- [ ] Original position shows shadow placeholder

### Drag States
- [ ] **Drag Start**: Card lifts with shadow, opacity changes to 0.7
- [ ] **Dragging**: Card follows cursor, drop zones highlight
- [ ] **Valid Drop**: Drop zone glows/highlights when card overlaps >50%
- [ ] **Invalid Drop**: Visual feedback prevents dropping in wrong areas
- [ ] **Drag Cancel**: ESC key or drag outside canvas returns card

### Drop Zone Detection
- [ ] Calculate overlap percentage with drop zone boundaries
- [ ] >50% overlap triggers valid drop state
- [ ] <50% overlap returns card to origin with animation
- [ ] Multiple drop zones show priority (closest to center)
- [ ] Visual feedback distinguishes valid/invalid zones

### Snap Behavior
- [ ] Cards snap to designated positions within piles
- [ ] Smooth animation to final position (200ms ease-out)
- [ ] Stack cards with slight offset for visibility
- [ ] Maintain pile organization and readability
- [ ] Prevent cards from overlapping completely

### Performance Optimization
- [ ] Use transform3d for hardware acceleration
- [ ] Debounce drag events to maintain 60fps
- [ ] Minimize DOM reflows during drag operations
- [ ] Virtual positioning for smooth movement
- [ ] Efficient collision detection algorithms

## Visual Feedback System
```javascript
// Drag states with visual feedback
const dragStates = {
  idle: { transform: 'scale(1)', shadow: '0 2px 4px rgba(0,0,0,0.1)' },
  lifting: { transform: 'scale(1.05)', shadow: '0 8px 16px rgba(0,0,0,0.2)' },
  dragging: { opacity: 0.7, transform: 'scale(1.02)', zIndex: 1000 },
  hovering: { borderColor: '#4A90E2', backgroundColor: '#F0F8FF' },
  dropping: { transform: 'scale(1)', opacity: 1 }
};
```

## Drop Zone Highlighting
- [ ] **Default State**: Subtle dashed border, neutral background
- [ ] **Valid Hover**: Solid border, light blue background glow
- [ ] **Active Drop**: Green border, success background tint
- [ ] **Invalid Drop**: Red border, error background tint
- [ ] **Pile Full**: Orange border with warning styling (Step 2/3)

### Touch Support
- [ ] Touch events handled separately from mouse events
- [ ] Long press (500ms) initiates drag on mobile
- [ ] Scroll prevention during drag operations
- [ ] Haptic feedback on successful drops
- [ ] Visual affordances for touch interactions

### Accessibility Features
- [ ] Keyboard drag-and-drop with arrow keys
- [ ] Screen reader announcements for drag states
- [ ] Focus management during drag operations
- [ ] High contrast mode support
- [ ] Clear visual feedback for all interactions

## Constraint Enforcement
- [ ] **Pile Limits**: Enforce maximum cards per pile (8 for Top 8, 3 for Top 3)
- [ ] **Overflow Handling**: Bounce animation for rejected drops
- [ ] **Staging Limit**: Maximum 1 card in staging area
- [ ] **Canvas Boundaries**: Prevent dragging outside canvas area
- [ ] **Z-index Management**: Ensure dragged cards stay on top

### Error Recovery
- [ ] Handle interrupted drag operations gracefully
- [ ] Restore card position on network disconnection
- [ ] Clear drag state on window blur/focus loss
- [ ] Timeout protection for stalled operations
- [ ] Consistent state across browser refresh

## Animation Specifications
```css
/* Core drag animations */
.card-drag-start {
  transition: transform 100ms ease-out, box-shadow 100ms ease-out;
  transform: scale(1.05);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
}

.card-dragging {
  opacity: 0.7;
  transform: scale(1.02);
  z-index: 1000;
  pointer-events: none;
}

.card-snap {
  transition: transform 200ms ease-out, opacity 200ms ease-out;
}

.pile-highlight {
  border: 2px solid #4A90E2;
  background-color: rgba(74, 144, 226, 0.1);
  transition: all 150ms ease-out;
}
```

## Integration Points
- [ ] **State Management**: Update pile arrays on successful drops
- [ ] **Real-time Sync**: Broadcast drag operations to other participants
- [ ] **Undo Support**: Track drag operations for potential undo
- [ ] **Analytics**: Log drag patterns for UX insights
- [ ] **Validation**: Ensure all moves comply with game rules

## Performance Requirements
- [ ] Maintain 60fps during drag operations
- [ ] <16ms response time for drag start
- [ ] <100ms snap animation completion
- [ ] Support 40+ cards without performance degradation
- [ ] Efficient memory usage during extended sessions

## Acceptance Criteria
- [ ] Cards respond immediately to drag initiation
- [ ] Drop zones provide clear visual feedback
- [ ] Snap animations complete smoothly within 200ms
- [ ] Pile limits enforced with appropriate feedback
- [ ] Touch and mouse interactions work consistently
- [ ] Performance remains smooth with maximum card count
- [ ] Accessibility features work with screen readers

## Test Cases
1. Drag cards to all valid drop zones and verify snapping
2. Test pile limit enforcement with bounce animation
3. Verify drop zone highlighting during hover states
4. Test drag cancellation (ESC key, drag outside)
5. Performance test with full 40-card deck
6. Touch interaction testing on mobile devices
7. Keyboard accessibility with arrow key navigation
8. Screen reader testing for drag state announcements
9. Test drag interruption recovery scenarios
10. Verify z-index management during complex drags

## Dependencies
- 01.1 Data Models âœ“
- 03.2 Animations Transitions (partial)
- 03.3 Pile Constraints (partial)

## Status: ðŸ”´ Not Started