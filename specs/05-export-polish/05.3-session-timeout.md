# Feature Spec: 05.3 - Session Timeout

## Overview
Manage session lifecycle with 60-minute timeout, 55-minute warning, and graceful cleanup to prevent resource leaks.

## User Story
As a participant, I receive advance warning before my session expires and can extend it if needed, ensuring I don't lose progress unexpectedly.

## Technical Requirements

### Timeout Management
- [ ] **Session Duration**: 60-minute maximum lifespan
- [ ] **Activity Tracking**: Reset timer on any user interaction
- [ ] **Warning System**: 5-minute advance notice (at 55 minutes)
- [ ] **Grace Period**: 2-minute extension opportunity after warning
- [ ] **Cleanup Process**: Automatic resource cleanup on expiry

### Activity Detection
- [ ] **Mouse Movement**: Reset timeout on cursor movement
- [ ] **Card Interactions**: Drag, drop, flip operations
- [ ] **Button Clicks**: Any UI interaction
- [ ] **Keyboard Input**: Text input, keyboard shortcuts
- [ ] **Real-time Activity**: Reveals, viewing others' work

```javascript
class SessionTimeoutManager {
  constructor(sessionDuration = 60 * 60 * 1000) { // 60 minutes
    this.sessionDuration = sessionDuration;
    this.warningTime = sessionDuration - (5 * 60 * 1000); // 55 minutes
    this.lastActivity = Date.now();
    this.warningShown = false;
    this.timeoutTimer = null;
    this.warningTimer = null;
    
    this.setupActivityTracking();
    this.startTimers();
  }
  
  resetTimeout() {
    this.lastActivity = Date.now();
    this.warningShown = false;
    this.restartTimers();
  }
  
  setupActivityTracking() {
    const events = ['mousedown', 'mousemove', 'keydown', 'touchstart', 'scroll'];
    events.forEach(event => {
      document.addEventListener(event, () => this.resetTimeout(), { passive: true });
    });
  }
}
```

### Warning System
- [ ] **Warning Modal**: Clear, prominent warning dialog
- [ ] **Countdown Display**: Show time remaining until expiry
- [ ] **Extend Options**: "Extend Session" and "Save and Leave" buttons
- [ ] **Auto-extend**: Option to automatically extend on any activity
- [ ] **Progress Preservation**: Warn about potential data loss

### Warning UI Implementation
```jsx
function SessionTimeoutWarning({ 
  timeRemaining, 
  onExtend, 
  onSaveAndLeave, 
  onDismiss 
}) {
  const [countdown, setCountdown] = useState(timeRemaining);
  
  useEffect(() => {
    const timer = setInterval(() => {
      setCountdown(prev => {
        if (prev <= 1000) {
          onSaveAndLeave(); // Auto-save on expiry
          return 0;
        }
        return prev - 1000;
      });
    }, 1000);
    
    return () => clearInterval(timer);
  }, []);
  
  return (
    <Modal className="timeout-warning" isOpen={true} onClose={onDismiss}>
      <div className="warning-header">
        <h2>‚è∞ Session Expiring Soon</h2>
        <div className="countdown">
          {Math.ceil(countdown / 1000)} seconds remaining
        </div>
      </div>
      
      <div className="warning-content">
        <p>Your session will expire automatically to free up resources for others.</p>
        <p>Your progress will be saved, but real-time collaboration will end.</p>
      </div>
      
      <div className="warning-actions">
        <button onClick={onExtend} className="primary-btn">
          Continue Session
        </button>
        <button onClick={onSaveAndLeave} className="secondary-btn">
          Save and Leave
        </button>
      </div>
    </Modal>
  );
}
```

### Cleanup Process
- [ ] **State Preservation**: Save current progress before cleanup
- [ ] **Channel Cleanup**: Unsubscribe from Ably channels
- [ ] **Memory Cleanup**: Clear timers, event listeners, references
- [ ] **Participant Removal**: Remove from session participant list
- [ ] **Resource Deallocation**: Free any allocated resources

### Server-side Timeout
- [ ] **Webhook Integration**: Ably webhook for session cleanup
- [ ] **Database Cleanup**: Remove expired session data
- [ ] **Resource Monitoring**: Track active sessions and cleanup
- [ ] **Backup Storage**: Temporary storage for recovery
- [ ] **Analytics Tracking**: Log session duration and completion rates

```javascript
// Server-side session cleanup
class ServerSessionManager {
  constructor() {
    this.activeSessions = new Map();
    this.cleanupInterval = setInterval(() => this.cleanupExpiredSessions(), 60000);
  }
  
  cleanupExpiredSessions() {
    const now = Date.now();
    for (const [sessionId, session] of this.activeSessions) {
      if (now - session.lastActivity > session.timeout) {
        this.expireSession(sessionId);
      }
    }
  }
  
  async expireSession(sessionId) {
    const session = this.activeSessions.get(sessionId);
    if (!session) return;
    
    // Save final state
    await this.saveSessionState(session);
    
    // Notify participants
    await this.notifyParticipants(session, 'session-expired');
    
    // Cleanup resources
    this.activeSessions.delete(sessionId);
    await this.cleanupResources(session);
  }
}
```

### Extension Mechanism
- [ ] **Simple Extension**: Add 30 minutes with single click
- [ ] **Activity-based**: Auto-extend on significant activity
- [ ] **Maximum Extensions**: Limit to prevent indefinite sessions
- [ ] **Resource Validation**: Check system capacity before extending
- [ ] **Participant Consent**: Require all active participants to agree

### Timeout States
- [ ] **Active**: Normal operation, timer running
- [ ] **Warning**: 55+ minutes, warning displayed
- [ ] **Grace**: 60+ minutes, final extension opportunity
- [ ] **Expired**: 62+ minutes, automatic cleanup initiated
- [ ] **Extended**: Timer reset, normal operation resumed

### User Experience
- [ ] **Non-intrusive Tracking**: Activity detection doesn't interfere with use
- [ ] **Clear Communication**: Users understand timeout policy
- [ ] **Graceful Degradation**: Smooth transition from active to expired
- [ ] **Data Protection**: Never lose user progress due to timeout
- [ ] **Recovery Options**: Help users resume if needed

## Error Handling
- [ ] **Clock Drift**: Handle client/server time differences
- [ ] **Network Issues**: Timeout handling during disconnection
- [ ] **Extension Failures**: Graceful handling of failed extensions
- [ ] **Cleanup Failures**: Retry mechanisms for cleanup operations
- [ ] **State Corruption**: Validate session state before operations

### Mobile Considerations
- [ ] **Background Behavior**: Handle app backgrounding/foregrounding
- [ ] **Battery Optimization**: Reduce timer frequency on mobile
- [ ] **Network Changes**: Adapt to cellular/WiFi transitions
- [ ] **Screen Lock**: Handle device sleep during sessions
- [ ] **Push Notifications**: Optional timeout warnings via push

### Accessibility
- [ ] **Screen Reader**: Announce timeout warnings clearly
- [ ] **High Contrast**: Ensure warning modal is visible
- [ ] **Keyboard Navigation**: Full keyboard control of timeout options
- [ ] **Focus Management**: Proper focus handling for timeout modal

## Analytics & Monitoring
```javascript
// Session timeout analytics
const TimeoutAnalytics = {
  trackSessionStart(sessionId, participantCount) {
    this.analytics.track('session_started', {
      session_id: sessionId,
      participant_count: participantCount,
      start_time: Date.now()
    });
  },
  
  trackTimeoutWarning(sessionId, timeActive) {
    this.analytics.track('timeout_warning_shown', {
      session_id: sessionId,
      time_active: timeActive,
      timestamp: Date.now()
    });
  },
  
  trackSessionExtension(sessionId, extensionCount) {
    this.analytics.track('session_extended', {
      session_id: sessionId,
      extension_count: extensionCount,
      timestamp: Date.now()
    });
  },
  
  trackSessionExpiry(sessionId, reason) {
    this.analytics.track('session_expired', {
      session_id: sessionId,
      expiry_reason: reason, // timeout, user_left, error
      timestamp: Date.now()
    });
  }
};
```

### Performance Considerations
- [ ] **Efficient Timers**: Use single timer for all timeout tracking
- [ ] **Debounced Activity**: Batch activity updates to prevent spam
- [ ] **Memory Management**: Clean up timeout-related data structures
- [ ] **Network Efficiency**: Minimize timeout-related network calls

### Configuration Options
- [ ] **Admin Settings**: Configurable session duration for different contexts
- [ ] **User Preferences**: Allow users to set timeout preferences
- [ ] **Context-aware**: Different timeouts for different activity levels
- [ ] **Group Settings**: Synchronize timeouts across all participants

## Testing Strategy
- [ ] **Time Simulation**: Fast-forward time for testing timeout scenarios
- [ ] **Activity Simulation**: Automated activity generation for testing
- [ ] **Network Interruption**: Test timeout during network issues
- [ ] **Concurrent Sessions**: Test cleanup with multiple simultaneous sessions
- [ ] **Edge Cases**: Test boundary conditions and error scenarios

### Security Considerations
- [ ] **Session Hijacking**: Prevent unauthorized session extensions
- [ ] **Resource Exhaustion**: Prevent malicious timeout manipulation
- [ ] **Data Integrity**: Ensure timeout doesn't corrupt session data
- [ ] **Access Control**: Validate permissions for timeout operations

## Acceptance Criteria
- [ ] Sessions automatically expire after 60 minutes of inactivity
- [ ] Warning appears at 55 minutes with countdown timer
- [ ] Users can extend sessions through warning dialog
- [ ] Activity properly resets timeout timer
- [ ] Cleanup process removes all session resources
- [ ] User progress is preserved through timeout process
- [ ] Mobile timeout behavior works correctly
- [ ] Accessibility features function properly

## Test Cases
1. Normal session timeout after 60 minutes of inactivity
2. Warning display at 55 minutes with proper countdown
3. Session extension through warning dialog
4. Activity detection and timeout reset
5. Cleanup process removes all resources properly
6. Multiple participant session timeout coordination
7. Mobile background/foreground timeout behavior
8. Network disconnection during timeout warning
9. Server-side cleanup webhook functionality
10. Performance testing with many concurrent timeouts

## Dependencies
- 01.2 Session Management ‚úì
- 04.1 Ably Setup ‚úì
- Server-side webhook infrastructure
- Analytics platform integration

## Status: üî¥ Not Started