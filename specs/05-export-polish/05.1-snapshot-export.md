# Feature Spec: 05.1 - Snapshot Export

## Overview
Allow participants to capture and download their card arrangements as JPG, PNG, or PDF files for sharing and record-keeping.

## User Story
As a participant, I can take a snapshot of my Top 8 or Top 3 leadership values arrangement to save and share my results.

## Technical Requirements

### Export Formats
- [ ] **JPG**: Standard quality for quick sharing (smaller file size)
- [ ] **PNG**: Higher quality with transparency support
- [ ] **PDF**: Vector format with metadata (participant name, session date)
- [ ] **Format Selection**: User choice via dropdown or button options

### Snapshot Trigger
- [ ] **"ðŸ“¸ Snapshot" Button**: Available on Top 8 and Top 3 review screens
- [ ] **Button Placement**: Positioned with Reveal and Next Step buttons
- [ ] **Loading State**: Show progress during capture and processing
- [ ] **Success Feedback**: Confirmation when download begins
- [ ] **Error Handling**: Clear messaging for failed exports

### Content Capture
- [ ] **Canvas Region**: Capture the expanded frame with cards
- [ ] **Header Information**: Include participant name and session details
- [ ] **Timestamp**: Add creation date and time
- [ ] **Title**: "Top 8/3 Leadership Values - Final Selection"
- [ ] **Branding**: Optional subtle branding/watermark

## Implementation Architecture
```javascript
import html2canvas from 'html2canvas';
import jsPDF from 'jspdf';

class SnapshotExporter {
  constructor() {
    this.canvas = null;
    this.isExporting = false;
  }
  
  async exportSnapshot(format = 'png', options = {}) {
    if (this.isExporting) return;
    
    this.isExporting = true;
    try {
      const canvas = await this.captureCanvas();
      await this.downloadFile(canvas, format, options);
    } catch (error) {
      this.handleExportError(error);
    } finally {
      this.isExporting = false;
    }
  }
  
  async captureCanvas() {
    const targetElement = document.getElementById('export-frame');
    return await html2canvas(targetElement, {
      backgroundColor: '#ffffff',
      scale: 2, // High DPI
      useCORS: true,
      allowTaint: false,
      scrollX: 0,
      scrollY: 0
    });
  }
}
```

### Header Generation
- [ ] **Participant Info**: Display participant name and emoji
- [ ] **Session Context**: "Session: ABC123" with session code
- [ ] **Timestamp**: Current date and time in readable format
- [ ] **Step Indicator**: "Top 8/3 Most Important Leadership Values"
- [ ] **Clean Layout**: Professional, printable formatting

### Export Processing
- [ ] **High DPI**: Capture at 2x scale for crisp output
- [ ] **Color Accuracy**: Ensure consistent colors across formats
- [ ] **Font Rendering**: Sharp text rendering in all formats
- [ ] **Background**: Clean white background for professional appearance
- [ ] **Bounds Detection**: Automatically crop to content area

## Format-Specific Implementation
```javascript
// PNG Export
async function exportPNG(canvas, filename) {
  const link = document.createElement('a');
  link.download = `${filename}.png`;
  link.href = canvas.toDataURL('image/png', 1.0);
  link.click();
}

// JPG Export
async function exportJPG(canvas, filename) {
  const link = document.createElement('a');
  link.download = `${filename}.jpg`;
  link.href = canvas.toDataURL('image/jpeg', 0.9);
  link.click();
}

// PDF Export
async function exportPDF(canvas, filename, metadata) {
  const pdf = new jsPDF({
    orientation: 'landscape',
    unit: 'px',
    format: [canvas.width, canvas.height]
  });
  
  // Add metadata
  pdf.setProperties({
    title: `${metadata.name}'s Leadership Values`,
    author: metadata.name,
    subject: 'Leadership Values Exercise',
    creator: 'Leadership Values Card Sort',
    creationDate: new Date()
  });
  
  pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, canvas.width, canvas.height);
  pdf.save(`${filename}.pdf`);
}
```

### File Naming Convention
- [ ] **Format**: `{ParticipantName}_Top{8|3}_Leadership_Values_{YYYYMMDD_HHMMSS}`
- [ ] **Examples**: 
  - `Sarah_Top8_Leadership_Values_20240115_143022.png`
  - `John_Top3_Leadership_Values_20240115_145533.pdf`
- [ ] **Sanitization**: Remove special characters, limit length
- [ ] **Uniqueness**: Timestamp prevents file conflicts

### Quality Settings
- [ ] **PNG**: Full quality (lossless compression)
- [ ] **JPG**: 90% quality (good balance of size/quality)
- [ ] **PDF**: Vector-based text where possible
- [ ] **Resolution**: 300 DPI equivalent for print quality
- [ ] **Color Space**: sRGB for consistent display

## User Interface
```jsx
// Snapshot button component
function SnapshotButton({ step, participantName, onExport }) {
  const [isExporting, setIsExporting] = useState(false);
  const [format, setFormat] = useState('png');
  
  const handleExport = async () => {
    setIsExporting(true);
    try {
      await onExport(format, { 
        participantName, 
        step,
        timestamp: new Date()
      });
    } finally {
      setIsExporting(false);
    }
  };
  
  return (
    <div className="snapshot-controls">
      <select value={format} onChange={(e) => setFormat(e.target.value)}>
        <option value="png">PNG (High Quality)</option>
        <option value="jpg">JPG (Smaller Size)</option>
        <option value="pdf">PDF (Printable)</option>
      </select>
      <button 
        onClick={handleExport} 
        disabled={isExporting}
        className="snapshot-btn"
      >
        {isExporting ? 'ðŸ“¸ Capturing...' : 'ðŸ“¸ Snapshot'}
      </button>
    </div>
  );
}
```

### Export Frame Preparation
- [ ] **Element Isolation**: Target specific DOM element for capture
- [ ] **Style Cleanup**: Ensure clean appearance for export
- [ ] **Temporary Modifications**: Hide UI elements not needed in export
- [ ] **Size Optimization**: Optimal dimensions for target format
- [ ] **Content Validation**: Verify all elements render correctly

### Progress Feedback
- [ ] **Loading Indicator**: Spinner or progress bar during capture
- [ ] **Status Messages**: "Preparing snapshot...", "Processing...", "Downloading..."
- [ ] **Time Estimates**: Show expected completion time for large exports
- [ ] **Cancel Option**: Allow cancellation of long-running exports

## Error Handling
- [ ] **Capture Failures**: Handle canvas rendering errors
- [ ] **Browser Support**: Graceful degradation for unsupported features
- [ ] **File System Errors**: Handle download permission issues
- [ ] **Memory Limits**: Handle large export memory requirements
- [ ] **Network Issues**: Handle failures in cloud processing

### Error Messages
| Error Type | Message | Recovery Action |
|------------|---------|-----------------|
| Canvas Error | "Unable to capture snapshot. Please try again." | Retry button |
| Download Block | "Download blocked. Please allow downloads for this site." | Instructions |
| Memory Limit | "Snapshot too large. Try a smaller format." | Format suggestion |
| Browser Support | "Snapshot feature not supported in this browser." | Browser upgrade |

### Performance Optimization
- [ ] **Lazy Loading**: Only load export libraries when needed
- [ ] **Canvas Caching**: Cache canvas for multiple format exports
- [ ] **Background Processing**: Use web workers for heavy processing
- [ ] **Memory Management**: Clean up resources after export
- [ ] **Compression**: Optimize file sizes without quality loss

## Accessibility
- [ ] **Screen Reader**: Announce export progress and completion
- [ ] **Keyboard Access**: Full keyboard control for export functions
- [ ] **Focus Management**: Maintain focus during export process
- [ ] **High Contrast**: Ensure export UI visible in accessibility modes

### Mobile Considerations
- [ ] **Touch Interface**: Large, touch-friendly export buttons
- [ ] **File Handling**: Native share API integration on mobile
- [ ] **Performance**: Optimize for mobile processing capabilities
- [ ] **Storage**: Handle mobile storage limitations

## Analytics & Tracking
- [ ] **Export Rates**: Track percentage of participants who export
- [ ] **Format Preferences**: Monitor most popular export formats
- [ ] **Success Rates**: Track successful vs failed exports
- [ ] **Performance Metrics**: Monitor export timing and errors

### Integration Points
- [ ] **Review Screens**: Seamlessly integrate with Top 8/3 review flows
- [ ] **Collaboration**: Export shared arrangements from viewer mode
- [ ] **Session Management**: Include session context in exports
- [ ] **Theme System**: Respect current theme in exported snapshots

## Acceptance Criteria
- [ ] Snapshot button appears on Top 8 and Top 3 review screens
- [ ] All three export formats (PNG, JPG, PDF) work correctly
- [ ] File naming follows consistent convention with timestamps
- [ ] Export quality is suitable for sharing and printing
- [ ] Loading states and progress feedback work smoothly
- [ ] Error cases handled gracefully with helpful messages
- [ ] Mobile export experience works reliably
- [ ] Accessibility features function properly

## Test Cases
1. Export Top 8 arrangement in all three formats
2. Export Top 3 arrangement with various card layouts
3. Test file naming with special characters in participant names
4. Verify export quality and content accuracy
5. Test export failure scenarios and error handling
6. Mobile export functionality on various devices
7. Performance testing with complex arrangements
8. Accessibility testing with screen readers
9. Browser compatibility across major browsers
10. Integration testing with review screen workflows

## Dependencies
- html2canvas library
- jsPDF library
- 02-core-flow (review screens) âœ“

## Status: ðŸ”´ Not Started