# Feature Spec: 01.2 - Session Management

## Overview
Handle session creation, joining, persistence, and cleanup with 60-minute timeout and participant management.

## User Story
As a participant, I can create or join a session with a simple 6-character code and remain connected with others throughout the exercise.

## Technical Requirements

### Session Creation
- [ ] Generate random 6-character alphanumeric codes (ABC123 format)
- [ ] Ensure code uniqueness across active sessions
- [ ] First participant creates Ably room automatically
- [ ] Store session metadata (creation time, deck type, settings)

### Session Joining
- [ ] Validate session code exists and is active
- [ ] Add participant to session with unique name handling
- [ ] Assign emoji and color from predefined palettes
- [ ] Redirect to canvas with session/name parameters

### Session Persistence
- [ ] In-memory storage for MVP/development
- [ ] Redis with 60-minute TTL for production
- [ ] Auto-cleanup on last participant leave
- [ ] Session recovery on reconnection

### Participant Management
- [ ] Track participant join/leave events
- [ ] Handle name conflicts (append numbers: John, John-2, John-3)
- [ ] Maintain participant count display
- [ ] Graceful handling of disconnections

### Session Lifecycle
- [ ] 60-minute inactivity timeout with 55-minute warning
- [ ] Session extends on any participant activity
- [ ] Clean shutdown when all participants leave
- [ ] Error recovery for partial failures

## Code Generation Algorithm
```javascript
function generateSessionCode() {
  return Math.random().toString(36).substring(2, 8).toUpperCase();
}

function ensureUniqueCode(existingSessions) {
  let code;
  do {
    code = generateSessionCode();
  } while (existingSessions.has(code));
  return code;
}
```

## Storage Hierarchy
```
1. URL parameters: /canvas?session=ABC123&name=John
2. localStorage: sessionCode, participantName  
3. Session default: "DEMO" for testing
```

## Session States
- **Creating**: First participant, setting up Ably channel
- **Active**: 1+ participants connected, accepting new joins
- **Warning**: 55+ minutes old, showing timeout warning
- **Expired**: 60+ minutes old, cleaning up resources
- **Ended**: No participants, resources cleaned

## Validation Rules
- [ ] Session code must be exactly 6 alphanumeric characters
- [ ] Maximum 50 participants per session
- [ ] Names must be 1-50 characters, alphanumeric + spaces + hyphens
- [ ] Session must exist to join
- [ ] Active sessions only accept new participants

## Error Handling
| Error | Message | Action |
|-------|---------|--------|
| Invalid code | "Session not found. Check the code or start a new session." | Return to welcome |
| Expired session | "This session has ended. Start a new session?" | Offer new session |
| Full session | "Session is full (50 participants max). Try another code." | Return to welcome |
| Connection lost | "Connection lost. Attempting to reconnect..." | Auto-retry 3x |

## Acceptance Criteria
- [ ] Can create sessions with unique codes consistently
- [ ] Can join existing sessions with valid codes
- [ ] Session persists with activity, expires after 60min inactivity
- [ ] Participant names are unique within session
- [ ] Session cleanup occurs reliably
- [ ] Error states handled gracefully

## Test Cases
1. Create new session and verify unique code generation
2. Join existing session with valid/invalid codes
3. Test participant limit (51st participant rejected)
4. Verify timeout behavior at 55 and 60 minutes
5. Test session cleanup on last participant leave
6. Handle duplicate names and special characters
7. Test connection recovery scenarios

## Dependencies
- 01.1 Data Models âœ“

## Status: ðŸ”´ Not Started