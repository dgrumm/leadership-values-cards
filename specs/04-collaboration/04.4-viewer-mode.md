# Feature Spec: 04.4 - Viewer Mode

## Overview
Read-only viewing experience for participants to see others' revealed card arrangements with live updates and viewer presence.

## User Story
As a participant, I can view others' revealed card selections in a dedicated full-screen mode with real-time updates and awareness of other viewers.

## Technical Requirements

### View Mode Interface
- [ ] **Full-screen Layout**: Dedicated view taking entire canvas area
- [ ] **Header Display**: "[Name]'s Top [8/3] Leadership Values"
- [ ] **Back Navigation**: "‚Üê Back to Participants" button
- [ ] **Viewer Avatars**: Small participant indicators in corner
- [ ] **Read-only State**: All interaction disabled except viewing

### Entry Points
- [ ] **Participant List**: "See [Name]'s Top 8/3" buttons
- [ ] **Direct Links**: URL-based access to specific reveals
- [ ] **Notification Clicks**: Click on "X revealed their cards" notifications
- [ ] **Quick Switch**: Navigate between different participants' reveals

### Layout Structure
```
[‚Üê Back to Participants]                    [üë§üë§üë§ +2 viewers]

                    Sarah's Top 8 Leadership Values

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îÇ
‚îÇ  ‚îÇ  TRUST  ‚îÇ  ‚îÇTEAMWORK ‚îÇ  ‚îÇBALANCE  ‚îÇ  ‚îÇINTEGRITY‚îÇ                    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îÇ
‚îÇ  ‚îÇCOMMITMENT‚îÇ ‚îÇHONESTY  ‚îÇ  ‚îÇ GROWTH  ‚îÇ  ‚îÇRESPECT  ‚îÇ                    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Real-time Updates
- [ ] **Live Sync**: See card movements as owner makes them
- [ ] **Smooth Transitions**: Cards animate to new positions for viewers
- [ ] **Update Indicators**: Highlight recently moved cards (subtle glow)
- [ ] **Activity Status**: Show when owner is actively rearranging
- [ ] **Cursor Display**: Show owner's cursor position to viewers

### Viewer Management
- [ ] **Join Notifications**: Announce when viewers enter/leave
- [ ] **Presence Tracking**: Track all active viewers per reveal
- [ ] **Avatar Display**: Show up to 5 viewer avatars with overflow indicator
- [ ] **Hover Details**: Display viewer names on avatar hover
- [ ] **Auto-cleanup**: Remove viewer data on disconnect

## Viewer State Management (Hybrid Architecture)
```typescript
class ViewerMode {
  constructor(sessionCode: string, participantId: string) {
    this.sessionCode = sessionCode;
    this.participantId = participantId;
  }
  
  async enterView(targetParticipantId: string) {
    // Get hybrid participant data
    const { participants } = usePresence(this.sessionCode, this.participantName);
    const targetParticipant = participants.find(p => p.participantId === targetParticipantId);
    
    if (!targetParticipant?.canViewTop8 && !targetParticipant?.canViewTop3) {
      throw new Error('Participant has not revealed any selections');
    }
    
    this.currentView = {
      participantId: targetParticipantId,
      participantData: targetParticipant,
      startTime: Date.now(),
      isActive: true
    };
    
    // Update presence to show viewing status (integrates with existing presence system)
    const presenceManager = usePresence();
    await presenceManager.updatePresence({
      isViewing: targetParticipantId
    });
  }
  
  async exitView() {
    if (!this.currentView) return;
    
    // Clear viewing status from presence (ephemeral)
    const presenceManager = usePresence();
    await presenceManager.updatePresence({
      isViewing: null
    });
    
    this.currentView = null;
  }
}
```

### Interactive Elements
- [ ] **Card Inspection**: Hover to see full card descriptions
- [ ] **Zoom Controls**: Zoom in/out on arrangement for detail
- [ ] **Arrangement History**: Timeline of changes (if available)
- [ ] **Export Options**: Save/share viewed arrangement
- [ ] **Discussion Annotations**: Comments on specific cards (future)

### Navigation Features
- [ ] **Quick Switch Menu**: Dropdown to switch between revealed participants
- [ ] **Keyboard Shortcuts**: Arrow keys to navigate between participants
- [ ] **Breadcrumb Trail**: Show viewing history
- [ ] **Recent Views**: Quick access to recently viewed arrangements

### Performance Optimization
- [ ] **Efficient Rendering**: Only render visible cards
- [ ] **Update Batching**: Group multiple card updates
- [ ] **Memory Management**: Clean up viewer data on exit
- [ ] **Network Efficiency**: Minimize update frequency for viewers

## Revealed Selection Display (Session-Based)
```typescript
// Display revealed selections from session data (read-only)
class RevealedSelectionDisplay {
  renderRevealedSelection(participant: ParticipantDisplayData, type: 'top8' | 'top3') {
    // Get revealed selection from session data (authoritative, persistent)
    const revealedCards = type === 'top8' 
      ? participant.revealedSelections?.top8
      : participant.revealedSelections?.top3;
    
    if (!revealedCards) {
      throw new Error(`No ${type} selection revealed for this participant`);
    }
    
    return {
      cards: revealedCards,
      participantName: participant.name,
      participantEmoji: participant.emoji,
      participantColor: participant.color,
      revealType: type,
      isReadOnly: true
    };
  }
  
  // Note: No live updates - revealed selections are snapshots
  // Owner can re-reveal to update, but viewers see stored selection
}
```

### Viewer Presence Display (Integrated with Existing System)
- [ ] **Use Existing Presence**: Leverage established presence system for viewer tracking
- [ ] **isViewing Status**: Use existing presence data to show who's viewing whom
- [ ] **Avatar Integration**: Use existing participant avatar/emoji system
- [ ] **Real-time Updates**: Viewing status updates via existing presence events
- [ ] **Presence Display**: Show viewers using existing ParticipantDisplayData structure

### Error Handling
- [ ] **Invalid Participant**: Handle viewing non-existent participants
- [ ] **Unrevealed Content**: Graceful handling of private arrangements
- [ ] **Connection Loss**: Maintain view state during reconnection
- [ ] **Sync Failures**: Retry failed arrangement updates
- [ ] **Navigation Errors**: Handle broken view transitions

### Mobile Considerations
- [ ] **Touch Navigation**: Swipe gestures for switching participants
- [ ] **Responsive Layout**: Adapt to smaller screens
- [ ] **Performance**: Optimize for mobile rendering
- [ ] **Battery Efficiency**: Reduce update frequency on mobile

## Accessibility Features
- [ ] **Screen Reader**: Describe arrangement layout and changes
- [ ] **Keyboard Navigation**: Full keyboard control for viewing
- [ ] **Focus Management**: Proper focus handling in view mode
- [ ] **High Contrast**: Ensure all elements visible in accessibility modes
- [ ] **Voice Descriptions**: Audio descriptions of arrangements

### Analytics Tracking
- [ ] **View Duration**: Track how long participants view others
- [ ] **Popular Views**: Which participants are viewed most
- [ ] **Engagement Patterns**: Common viewing flows and behaviors
- [ ] **Discussion Triggers**: Correlate views with reveal rates

## UI Components (Hybrid Architecture Integration)
```jsx
// Viewer mode header using hybrid data
function ViewerHeader({ 
  participant, 
  revealType, 
  onBack 
}: { 
  participant: ParticipantDisplayData, 
  revealType: 'top8' | 'top3',
  onBack: () => void 
}) {
  const { participants } = usePresence(); // Get all participants with viewer status
  const viewers = participants.filter(p => p.isViewing === participant.participantId);
  
  return (
    <header className="viewer-header">
      <button className="back-btn" onClick={onBack}>
        ‚Üê Back to Participants
      </button>
      <h1>
        {participant.emoji} {participant.name}'s Top {revealType === 'top8' ? '8' : '3'} Leadership Values
      </h1>
      <ViewerAvatars viewers={viewers} />
    </header>
  );
}

// Viewer avatars using existing participant display data
function ViewerAvatars({ viewers }: { viewers: ParticipantDisplayData[] }) {
  const visibleViewers = viewers.slice(0, 5);
  const overflowCount = Math.max(0, viewers.length - 5);
  
  return (
    <div className="viewer-avatars">
      {visibleViewers.map(viewer => (
        <div 
          key={viewer.participantId}
          className="viewer-avatar"
          style={{ backgroundColor: viewer.color }}
          title={viewer.name}
        >
          {viewer.emoji}
        </div>
      ))}
      {overflowCount > 0 && (
        <div className="viewer-overflow">+{overflowCount}</div>
      )}
    </div>
  );
}

// Main viewer mode component
function ViewerMode({ 
  targetParticipantId, 
  revealType 
}: { 
  targetParticipantId: string, 
  revealType: 'top8' | 'top3' 
}) {
  const { participants } = usePresence();
  const targetParticipant = participants.find(p => p.participantId === targetParticipantId);
  const { enterViewMode, exitViewMode } = useViewerManager();
  
  useEffect(() => {
    enterViewMode(targetParticipantId);
    return () => exitViewMode();
  }, [targetParticipantId]);
  
  if (!targetParticipant) return <div>Participant not found</div>;
  
  const revealedCards = revealType === 'top8' 
    ? targetParticipant.revealedSelections?.top8
    : targetParticipant.revealedSelections?.top3;
  
  if (!revealedCards) return <div>No revealed selection</div>;
  
  return (
    <div className="viewer-mode">
      <ViewerHeader 
        participant={targetParticipant} 
        revealType={revealType}
        onBack={exitViewMode}
      />
      <div className="revealed-cards-display">
        {revealedCards.map(card => (
          <Card key={card.id} {...card} isReadOnly />
        ))}
      </div>
    </div>
  );
}
```

### Security Considerations
- [ ] **Access Control**: Only session participants can enter viewer mode
- [ ] **Data Validation**: Validate all viewer messages
- [ ] **Privacy Respect**: Only show explicitly revealed arrangements
- [ ] **Session Boundaries**: Prevent cross-session viewing

## Acceptance Criteria
- [ ] Can enter full-screen viewer mode for any revealed participant
- [ ] Real-time updates show smoothly as owner moves cards
- [ ] Viewer presence accurately displays current viewers
- [ ] Navigation between different participants' reveals works seamlessly
- [ ] Back button returns to participants list correctly
- [ ] Performance remains smooth with multiple simultaneous viewers
- [ ] Mobile experience works with touch navigation
- [ ] Accessibility features function with screen readers

## Test Cases
1. Enter viewer mode and verify correct arrangement display
2. Test real-time updates while owner rearranges cards
3. Multiple viewers viewing same arrangement simultaneously
4. Navigate between different participants' revealed arrangements
5. Test viewer presence indicators and avatar display
6. Mobile viewer experience with touch navigation
7. Network interruption during viewing session
8. Invalid participant or unrevealed arrangement handling
9. Performance test with maximum viewers per arrangement
10. Accessibility testing with keyboard navigation and screen readers

## Dependencies
- 04.1 Ably Setup ‚úì
- 04.2 Participants Overview ‚úì
- 04.3 Reveal Mechanism ‚úì
- 04.5 Local vs Shared State Architecture ‚úì (hybrid data foundation)

## Status: üî¥ Not Started