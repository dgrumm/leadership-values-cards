# Feature Spec: 04.2 - Presence System

## Overview
Real-time participant tracking with live cursors, status updates, and participant list management.

## User Story
As a participant, I can see who else is in my session, what step they're on, and their live activity through cursor movements and status updates.

## Technical Requirements

### Participant Tracking
- [ ] Track all participants currently in session
- [ ] Show participant count in header: "👥5 Participants"
- [ ] Display participant status: sorting, revealed-8, revealed-3, completed
- [ ] Assign unique emoji and color to each participant
- [ ] Handle participant join/leave events in real-time

### Live Cursors
- [ ] Show other participants' cursor positions
- [ ] Display participant name/emoji near cursor
- [ ] Throttle cursor updates to 50ms (20fps)
- [ ] Hide cursors when participants are inactive (5s timeout)
- [ ] Smooth cursor interpolation for fluid movement

### Presence Data Structure
```javascript
interface PresenceData {
  participantId: string;
  name: string;
  emoji: string;
  color: string;
  currentStep: 1 | 2 | 3;
  status: 'sorting' | 'revealed-8' | 'revealed-3' | 'completed';
  cursor: {
    x: number;
    y: number;
    timestamp: number;
  };
  lastActive: number;
  isViewing: string | null; // participant ID being viewed
}
```

### Cursor Implementation
- [ ] **Cursor Rendering**: SVG cursors with participant colors
- [ ] **Position Tracking**: Mouse/touch position relative to canvas
- [ ] **Smooth Movement**: CSS transitions for interpolated positions
- [ ] **Viewport Sync**: Coordinate system consistent across participants
- [ ] **Performance**: Efficient cursor updates without frame drops

### Status Broadcasting
- [ ] **Step Changes**: Immediately broadcast step progression
- [ ] **Reveal Actions**: Announce when participant reveals cards
- [ ] **Completion Status**: Update when participant completes exercise
- [ ] **Activity Heartbeat**: Periodic presence refresh (30s)
- [ ] **Viewing Status**: Track who is viewing whose revealed cards

## Presence Channel Management
```javascript
class PresenceManager {
  constructor(ablyService, sessionCode) {
    this.channel = ablyService.getChannel(sessionCode, 'presence');
    this.participants = new Map();
    this.cursors = new Map();
    
    this.setupPresenceListeners();
    this.startCursorTracking();
    this.startHeartbeat();
  }
  
  enter(participantData) {
    this.channel.presence.enter(participantData);
  }
  
  updateStatus(status) {
    const updatedData = { ...this.currentData, status };
    this.channel.presence.update(updatedData);
  }
  
  updateCursor(x, y) {
    this.throttledCursorUpdate(x, y);
  }
}
```

### Participant List UI
- [ ] **Grid Layout**: Participant cards in responsive grid
- [ ] **Status Indicators**: Visual status (step progress, completion)
- [ ] **Action Buttons**: "View [Name]'s Top 8/3" for revealed participants
- [ ] **Real-time Updates**: List updates as participants join/leave/progress
- [ ] **Activity Indicators**: Show who is currently active

### Cursor Visualization
- [ ] **Custom Cursor Design**: Branded cursor with participant identifier
- [ ] **Color Coding**: Each participant gets unique color from palette
- [ ] **Name Labels**: Show participant name near cursor
- [ ] **Smooth Transitions**: Interpolated movement between positions
- [ ] **Hide/Show Logic**: Fade out inactive cursors

## Color & Emoji Assignment
```javascript
const PARTICIPANT_COLORS = [
  '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57',
  '#FF9FF3', '#54A0FF', '#5F27CD', '#00D2D3', '#FF9F43',
  '#10AC84', '#EE5A24', '#0984E3', '#6C5CE7', '#FD79A8'
];

const PARTICIPANT_EMOJIS = [
  '😊', '🎨', '🎭', '🎪', '🎯', '🎸', '🎺', '🌟', '💫', '🚀',
  '🎲', '🎈', '🎊', '🎉', '🎁', '🌈', '⭐', '🎋', '🎃', '🎄'
];

function assignParticipantIdentity(existingParticipants) {
  const usedColors = existingParticipants.map(p => p.color);
  const usedEmojis = existingParticipants.map(p => p.emoji);
  
  const availableColor = PARTICIPANT_COLORS.find(c => !usedColors.includes(c));
  const availableEmoji = PARTICIPANT_EMOJIS.find(e => !usedEmojis.includes(e));
  
  return { color: availableColor, emoji: availableEmoji };
}
```

### Activity Tracking
- [ ] **Mouse Movement**: Track cursor position changes
- [ ] **Card Interactions**: Note drag/drop activities
- [ ] **Button Clicks**: Track UI interactions
- [ ] **Idle Detection**: Mark participants inactive after 5 minutes
- [ ] **Session Timeout**: Handle 60-minute session expiry

### Mobile Considerations
- [ ] **Touch Cursors**: Show touch positions for mobile users
- [ ] **Gesture Tracking**: Track pinch/zoom and pan gestures
- [ ] **Battery Optimization**: Reduce update frequency on mobile
- [ ] **Network Adaptation**: Adjust update rates based on connection quality

## Privacy Controls
- [ ] **Cursor Privacy**: Option to hide cursor from others
- [ ] **Status Privacy**: Control visibility of step progress
- [ ] **View Notifications**: Show who is viewing your revealed cards
- [ ] **Activity Status**: Control whether to show as "active" or "away"

### Performance Optimization
- [ ] **Throttled Updates**: Cursor updates limited to 50ms intervals
- [ ] **Spatial Partitioning**: Only show cursors in visible viewport
- [ ] **Memory Management**: Clean up disconnected participant data
- [ ] **Network Efficiency**: Batch presence updates where possible

## Error Handling
- [ ] **Connection Loss**: Gracefully handle presence disconnection
- [ ] **Stale Data**: Clean up outdated participant information
- [ ] **Cursor Sync**: Handle cursor position desync
- [ ] **Presence Conflicts**: Resolve participant state conflicts
- [ ] **Channel Errors**: Recover from presence channel failures

### Accessibility
- [ ] **Screen Reader**: Announce participant joins/leaves
- [ ] **Status Updates**: Accessible participant status indicators
- [ ] **Cursor Alternatives**: Text-based presence for screen readers
- [ ] **High Contrast**: Ensure cursor visibility in all modes

## Real-time Features
```javascript
// Cursor update throttling
const throttledCursorUpdate = throttle((x, y) => {
  presenceChannel.publish('cursor-move', {
    participantId: currentUser.id,
    x, y,
    timestamp: Date.now()
  });
}, 50);

// Status update broadcasting
function broadcastStatusChange(newStatus) {
  presenceChannel.publish('status-update', {
    participantId: currentUser.id,
    status: newStatus,
    step: currentStep,
    timestamp: Date.now()
  });
}
```

### Heartbeat System
- [ ] **Periodic Ping**: Send heartbeat every 30 seconds
- [ ] **Activity Validation**: Confirm participant still active
- [ ] **Cleanup Trigger**: Remove inactive participants after timeout
- [ ] **Reconnection Sync**: Re-sync presence on reconnection

## Acceptance Criteria
- [ ] Participant count displays accurately in real-time
- [ ] Live cursors show smoothly with proper throttling
- [ ] Status updates broadcast immediately to all participants
- [ ] Participant list updates dynamically with joins/leaves
- [ ] Color and emoji assignment works without conflicts
- [ ] Performance maintained with maximum participants (50)
- [ ] Error states handled gracefully with recovery
- [ ] Mobile cursor tracking works on touch devices

## Test Cases
1. Join session and verify presence data synchronization
2. Test cursor movement throttling and smooth display
3. Progress through steps and verify status broadcasting
4. Test participant limit (50) and color/emoji assignment
5. Simulate network interruption and presence recovery
6. Test mobile cursor tracking and touch interactions
7. Verify participant list updates with rapid join/leave
8. Test cursor cleanup on participant disconnect
9. Load test with maximum concurrent cursor updates
10. Test accessibility features with screen readers

## Dependencies
- 04.1 Ably Setup ✓
- 01.2 Session Management ✓
- Canvas coordinate system

## Status: 🔴 Not Started