# Feature Spec: 04.2.1 - Header Integration

## Overview
Participant count button in the main application header that displays real-time participant count and provides navigation to the participants overview screen.

## User Story
As a participant, I can see how many people are in my session through a button in the header, and clicking it takes me to see all participants.

## Technical Requirements

### Header Button Component
- [ ] **Button Location**: Top-right area of main app header (consistent across all pages)
- [ ] **Button Text**: "ðŸ‘¥ N Participant(s)" where N is live count including self
- [ ] **Button Styling**: Consistent with existing header button design system
- [ ] **Responsive Design**: Collapses appropriately on mobile screens
- [ ] **Accessibility**: Proper ARIA labels and keyboard navigation

### Real-time Count Updates
- [ ] **Live Updates**: Count updates immediately when participants join/leave
- [ ] **Animation**: Smooth count transitions (e.g., 3 â†’ 4 participants)
- [ ] **Visual Feedback**: Brief highlight or pulse when count changes
- [ ] **Accuracy**: Count includes current user (self) in total
- [ ] **Network Resilience**: Graceful handling when sync temporarily fails

### Visual Indicators
- [ ] **Join Animation**: Green pulse or brief highlight when count increases
- [ ] **Leave Animation**: Red pulse or brief highlight when count decreases  
- [ ] **Loading State**: Spinner or skeleton when initially loading count
- [ ] **Error State**: Clear indication when count cannot be determined
- [ ] **Offline State**: Show cached count with offline indicator

## Implementation Details

### Header Integration
```typescript
// components/layout/Header.tsx integration
interface HeaderProps {
  sessionCode?: string;
  // ... existing props
}

function Header({ sessionCode, ...props }) {
  return (
    <header className="app-header">
      {/* ... existing header elements */}
      
      {sessionCode && (
        <ParticipantCountButton sessionCode={sessionCode} />
      )}
    </header>
  );
}
```

### Participant Count Button
```typescript
// components/collaboration/ParticipantCountButton.tsx
interface ParticipantCountButtonProps {
  sessionCode: string;
}

function ParticipantCountButton({ sessionCode }) {
  const { participantCount, isLoading, error } = useParticipantCount(sessionCode);
  const router = useRouter();
  
  const handleClick = () => {
    router.push(`/session/${sessionCode}/participants`);
  };
  
  if (isLoading) {
    return (
      <button className="participant-count-btn loading" disabled>
        ðŸ‘¥ <Spinner />
      </button>
    );
  }
  
  if (error) {
    return (
      <button className="participant-count-btn error" onClick={handleClick}>
        ðŸ‘¥ ? Participants
      </button>
    );
  }
  
  return (
    <motion.button
      className="participant-count-btn"
      onClick={handleClick}
      whileHover={{ scale: 1.05 }}
      whileTap={{ scale: 0.95 }}
      animate={participantCount ? { 
        scale: [1, 1.1, 1],
        transition: { duration: 0.3 }
      } : {}}
    >
      ðŸ‘¥ {participantCount} Participant{participantCount !== 1 ? 's' : ''}
    </motion.button>
  );
}
```

### Real-time Hook
```typescript
// hooks/collaboration/useParticipantCount.ts
function useParticipantCount(sessionCode: string) {
  const [participantCount, setParticipantCount] = useState<number | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const prevCount = useRef<number | null>(null);
  
  useEffect(() => {
    if (!sessionCode) return;
    
    const ablyService = AblyService.getInstance();
    const channel = ablyService.getChannel(sessionCode, 'participants');
    
    // Subscribe to participant events
    const handleParticipantJoin = (message: any) => {
      setParticipantCount(prev => prev ? prev + 1 : 1);
    };
    
    const handleParticipantLeave = (message: any) => {
      setParticipantCount(prev => prev ? Math.max(prev - 1, 0) : 0);
    };
    
    const handleCountSync = (message: any) => {
      setParticipantCount(message.data.count);
    };
    
    channel.subscribe('participant-joined', handleParticipantJoin);
    channel.subscribe('participant-left', handleParticipantLeave);
    channel.subscribe('count-sync', handleCountSync);
    
    // Initial count fetch
    channel.publish('request-count', {});
    
    return () => {
      channel.unsubscribe('participant-joined', handleParticipantJoin);
      channel.unsubscribe('participant-left', handleParticipantLeave);  
      channel.unsubscribe('count-sync', handleCountSync);
    };
  }, [sessionCode]);
  
  return { participantCount, isLoading, error };
}
```

### Styling
```css
/* components/collaboration/ParticipantCountButton.module.css */
.participant-count-btn {
  @apply flex items-center gap-2 px-4 py-2;
  @apply bg-white hover:bg-gray-50 border border-gray-200 rounded-lg;
  @apply text-sm font-medium text-gray-700 hover:text-gray-900;
  @apply transition-all duration-200 cursor-pointer;
  @apply focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50;
}

.participant-count-btn.loading {
  @apply opacity-75 cursor-not-allowed;
}

.participant-count-btn.error {
  @apply border-red-200 text-red-600 hover:text-red-700;
}

@media (max-width: 640px) {
  .participant-count-btn {
    @apply px-2 py-1 text-xs;
  }
}
```

### Page Integration
- [ ] **Step 1 Page**: Header includes participant count button
- [ ] **Step 2 Page**: Header includes participant count button  
- [ ] **Step 3 Page**: Header includes participant count button
- [ ] **All Session Pages**: Consistent header presence
- [ ] **Non-session Pages**: Button hidden when no session active

### URL Routing
- [ ] **Participants Route**: `/session/[code]/participants` 
- [ ] **Return Navigation**: Breadcrumb or back button to return to previous page
- [ ] **Deep Linking**: Direct URL access to participants page
- [ ] **Session Validation**: Verify session exists before showing count

## Error Handling
- [ ] **Connection Loss**: Show cached count with offline indicator
- [ ] **Invalid Session**: Hide button or show error state
- [ ] **Network Errors**: Retry mechanism with exponential backoff
- [ ] **Malformed Data**: Graceful degradation to "? Participants"
- [ ] **Rate Limiting**: Respect Ably rate limits for count requests

### Mobile Considerations
- [ ] **Touch Targets**: Minimum 44px touch target size
- [ ] **Text Sizing**: Readable text on small screens
- [ ] **Spacing**: Adequate spacing from other header elements
- [ ] **Performance**: Efficient rendering on mobile devices

## Accessibility Features
- [ ] **ARIA Labels**: "View N participants in session"
- [ ] **Keyboard Navigation**: Tab order and Enter/Space activation
- [ ] **Screen Reader**: Announce count changes
- [ ] **High Contrast**: Visible in accessibility modes
- [ ] **Focus Indicators**: Clear focus states

## Performance Requirements
- [ ] **Fast Updates**: Count updates within 100ms of participant changes
- [ ] **Memory Efficient**: No memory leaks from event subscriptions
- [ ] **Network Efficient**: Batch count updates when possible
- [ ] **Rendering Performance**: Smooth animations without frame drops

## Security Considerations
- [ ] **Session Validation**: Verify user has access to session
- [ ] **Data Sanitization**: Validate all count data
- [ ] **Rate Limiting**: Prevent spam of count requests
- [ ] **Session Isolation**: Count only includes current session participants

## Acceptance Criteria
- [ ] Participant count displays accurately in real-time
- [ ] Button is visible in header on all session pages
- [ ] Clicking button navigates to participants overview
- [ ] Count includes current user in total
- [ ] Visual feedback shows when participants join/leave
- [ ] Works properly on mobile devices
- [ ] Accessible via keyboard navigation
- [ ] Handles network errors gracefully
- [ ] Performance remains smooth with frequent updates

## Test Cases
1. **Initial Display**: Verify button shows correct initial count
2. **Real-time Updates**: Test count changes when participants join/leave
3. **Navigation**: Verify click navigates to participants overview
4. **Visual Feedback**: Test animations for join/leave events
5. **Error States**: Network disconnection and invalid session handling
6. **Mobile Experience**: Touch interactions and responsive design
7. **Accessibility**: Screen reader announcements and keyboard navigation
8. **Performance**: Rapid participant changes don't cause issues

## Dependencies
- 04.1 Ably Setup âœ“
- 01.2 Session Management âœ“
- Router/navigation system

## Integration Points
- **Next Sub-spec**: 04.2.2 Participant Cards (navigation target)
- **Main Header**: Integration with existing header component
- **Session Context**: Access to current session code
- **Routing**: Navigation to participants overview page

## Status: ðŸ”´ Not Started

**Implementation Priority**: High - Foundation for participants feature  
**Estimated Complexity**: Medium - Real-time sync with UI integration  
**Design Dependencies**: Header design system, button styling standards