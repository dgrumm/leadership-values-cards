# Feature Spec: 04.2.4 - Navigation & Actions

## Overview
Interactive elements and navigation flows for the participants overview screen, including entry/exit points, view action buttons, mobile considerations, and accessibility features.

## User Story
As a participant, I can easily navigate to and from the participants overview screen, and interact with view buttons to see other participants' revealed card arrangements.

## Technical Requirements

### Entry Points
- [ ] **Header Button**: Primary entry from participant count button (04.2.1)
- [ ] **Direct URL**: Deep link access via `/session/[code]/participants`
- [ ] **Notification Clicks**: Navigate from join/reveal notifications
- [ ] **Breadcrumb Links**: Return navigation from other collaboration features
- [ ] **Session Validation**: Verify session access before allowing entry

### Exit Points
- [ ] **Return Navigation**: Back to previous page (sorting canvas)
- [ ] **View Actions**: Navigate to specific participant views (04.4 Viewer Mode)
- [ ] **Session Leave**: Exit session entirely
- [ ] **Browser Back**: Handle browser back button gracefully
- [ ] **URL Changes**: Handle direct URL navigation away from screen

### View Action Buttons
- [ ] **Top 8 Buttons**: "See [Name]'s Top 8" for participants with revealed Step 2
- [ ] **Top 3 Buttons**: "See [Name]'s Top 3" for participants with revealed Step 3
- [ ] **Button Priority**: Top 3 takes precedence when both available
- [ ] **Disabled States**: Clear visual indication when view unavailable
- [ ] **Loading States**: Button feedback during navigation

### Navigation Flow Management
- [ ] **State Preservation**: Maintain scroll position and view state
- [ ] **History Management**: Proper browser history handling
- [ ] **Route Protection**: Prevent access to invalid sessions
- [ ] **Seamless Transitions**: Smooth navigation between screens
- [ ] **Error Recovery**: Handle navigation failures gracefully

## Implementation Details

### Main Navigation Component
```typescript
// components/collaboration/ParticipantsOverview.tsx
interface ParticipantsOverviewProps {
  sessionCode: string;
  currentUser: ParticipantOverviewData;
}

function ParticipantsOverview({ sessionCode, currentUser }) {
  const router = useRouter();
  const { participants, isLoading, error } = useParticipants(sessionCode, currentUser);
  const [isNavigating, setIsNavigating] = useState(false);
  
  const handleReturnToCanvas = useCallback(() => {
    setIsNavigating(true);
    router.push(`/session/${sessionCode}/canvas`);
  }, [sessionCode, router]);
  
  const handleViewParticipant = useCallback(async (
    participantId: string, 
    viewType: 'top8' | 'top3'
  ) => {
    setIsNavigating(true);
    
    try {
      // Pre-validate that participant has revealed the requested type
      const participant = participants.find(p => p.id === participantId);
      if (!participant || !participant.revealed[viewType]) {
        throw new Error(`Participant has not revealed ${viewType}`);
      }
      
      await router.push(`/session/${sessionCode}/view/${participantId}/${viewType}`);
    } catch (error) {
      console.error('Navigation failed:', error);
      setIsNavigating(false);
      // Show error toast or modal
    }
  }, [sessionCode, participants, router]);
  
  const handleLeaveSession = useCallback(() => {
    if (confirm('Are you sure you want to leave this session?')) {
      router.push('/');
    }
  }, [router]);
  
  if (error) {
    return <ErrorBoundary error={error} onRetry={() => window.location.reload()} />;
  }
  
  return (
    <div className="participants-overview-container">
      <NavigationHeader
        sessionCode={sessionCode}
        participantCount={participants.length}
        onReturnToCanvas={handleReturnToCanvas}
        onLeaveSession={handleLeaveSession}
        isNavigating={isNavigating}
      />
      
      <ParticipantsGrid
        participants={participants}
        currentUserId={currentUser.id}
        onViewParticipant={handleViewParticipant}
        isLoading={isLoading || isNavigating}
      />
      
      {isNavigating && <NavigationOverlay />}
    </div>
  );
}
```

### Navigation Header Component
```typescript
// components/collaboration/NavigationHeader.tsx
interface NavigationHeaderProps {
  sessionCode: string;
  participantCount: number;
  onReturnToCanvas: () => void;
  onLeaveSession: () => void;
  isNavigating?: boolean;
}

function NavigationHeader({
  sessionCode,
  participantCount,
  onReturnToCanvas,
  onLeaveSession,
  isNavigating = false
}) {
  return (
    <header className="participants-nav-header bg-white border-b border-gray-200 px-6 py-4">
      <div className="flex items-center justify-between max-w-7xl mx-auto">
        <div className="flex items-center gap-4">
          <button
            className="return-btn flex items-center gap-2 text-gray-600 hover:text-gray-900"
            onClick={onReturnToCanvas}
            disabled={isNavigating}
          >
            <ArrowLeftIcon className="w-5 h-5" />
            Continue Sorting
          </button>
          
          <div className="text-gray-400">|</div>
          
          <h1 className="text-xl font-semibold text-gray-900">
            Session Participants
          </h1>
        </div>
        
        <div className="flex items-center gap-4">
          <div className="participant-count-display text-sm text-gray-600">
            ðŸ‘¥ {participantCount} Participant{participantCount !== 1 ? 's' : ''}
          </div>
          
          <button
            className="leave-session-btn text-red-600 hover:text-red-700 text-sm"
            onClick={onLeaveSession}
            disabled={isNavigating}
          >
            Leave Session
          </button>
        </div>
      </div>
    </header>
  );
}
```

### Route Protection Hook
```typescript
// hooks/collaboration/useSessionAccess.ts
function useSessionAccess(sessionCode: string) {
  const [hasAccess, setHasAccess] = useState<boolean | null>(null);
  const [isValidating, setIsValidating] = useState(true);
  const router = useRouter();
  
  useEffect(() => {
    const validateSessionAccess = async () => {
      try {
        // Check if user has access to this session
        const response = await fetch(`/api/sessions/${sessionCode}/validate`);
        
        if (response.ok) {
          setHasAccess(true);
        } else if (response.status === 404) {
          setHasAccess(false);
          router.replace('/session-not-found');
        } else if (response.status === 403) {
          setHasAccess(false);
          router.replace('/access-denied');
        } else {
          throw new Error('Session validation failed');
        }
      } catch (error) {
        console.error('Session validation error:', error);
        setHasAccess(false);
      } finally {
        setIsValidating(false);
      }
    };
    
    if (sessionCode) {
      validateSessionAccess();
    }
  }, [sessionCode, router]);
  
  return { hasAccess, isValidating };
}
```

### View Action Button Component
```typescript
// components/collaboration/ViewActionButton.tsx
interface ViewActionButtonProps {
  participant: ParticipantOverviewData;
  viewType: 'top8' | 'top3';
  onClick: () => void;
  disabled?: boolean;
  loading?: boolean;
}

function ViewActionButton({
  participant,
  viewType,
  onClick,
  disabled = false,
  loading = false
}) {
  const isRevealed = participant.revealed[viewType];
  const buttonText = `See ${participant.name}'s Top ${viewType === 'top8' ? '8' : '3'}`;
  const isPrimary = viewType === 'top3';
  
  if (!isRevealed) return null;
  
  return (
    <motion.button
      className={cn(
        "view-action-btn px-4 py-2 rounded-lg font-medium text-sm",
        "transition-all duration-200 cursor-pointer min-w-[140px]",
        "focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50",
        isPrimary ? [
          "bg-white text-blue-700 hover:bg-blue-50",
          "shadow-md hover:shadow-lg"
        ] : [
          "bg-blue-800 text-white border border-blue-400",
          "hover:bg-blue-700 hover:border-blue-300"
        ],
        (disabled || loading) && "opacity-60 cursor-not-allowed",
      )}
      onClick={onClick}
      disabled={disabled || loading}
      whileHover={!disabled && !loading ? { scale: 1.05 } : {}}
      whileTap={!disabled && !loading ? { scale: 0.95 } : {}}
    >
      {loading ? (
        <div className="flex items-center justify-center gap-2">
          <Spinner className="w-4 h-4" />
          Loading...
        </div>
      ) : (
        buttonText
      )}
    </motion.button>
  );
}
```

### Mobile Navigation
- [ ] **Touch Targets**: Minimum 44px touch targets for all interactive elements
- [ ] **Swipe Gestures**: Optional swipe to go back to canvas
- [ ] **Mobile Header**: Responsive header design for small screens
- [ ] **Bottom Navigation**: Alternative navigation pattern for mobile
- [ ] **Orientation Support**: Proper layout in portrait/landscape

### URL Management
```typescript
// pages/session/[code]/participants.tsx
export default function ParticipantsPage() {
  const router = useRouter();
  const { code } = router.query;
  const sessionCode = Array.isArray(code) ? code[0] : code;
  
  const { hasAccess, isValidating } = useSessionAccess(sessionCode);
  const { currentUser } = useSession();
  
  if (isValidating) {
    return <PageLoadingSpinner />;
  }
  
  if (!hasAccess || !sessionCode) {
    return <AccessDeniedPage />;
  }
  
  if (!currentUser) {
    return <LoginPrompt sessionCode={sessionCode} />;
  }
  
  return (
    <ParticipantsOverview
      sessionCode={sessionCode}
      currentUser={currentUser}
    />
  );
}
```

### Accessibility Features
- [ ] **Keyboard Navigation**: Full keyboard support for all interactions
- [ ] **Screen Reader Support**: Proper ARIA labels and announcements
- [ ] **Focus Management**: Logical tab order and focus indicators
- [ ] **High Contrast**: Ensure visibility in accessibility modes
- [ ] **Voice Navigation**: Support for voice control interfaces

### Error Handling
- [ ] **Navigation Failures**: Graceful handling of failed navigation
- [ ] **Invalid Sessions**: Clear messaging for inaccessible sessions
- [ ] **Network Errors**: Offline state handling and recovery
- [ ] **Permission Errors**: Clear feedback for access restrictions
- [ ] **Malformed URLs**: Handle invalid session codes or paths

### Performance Optimization
- [ ] **Route Prefetching**: Prefetch likely navigation targets
- [ ] **State Caching**: Cache participant data during navigation
- [ ] **Lazy Loading**: Load navigation-heavy components on demand
- [ ] **Memory Management**: Clean up navigation state on unmount

## Mobile Considerations
- [ ] **Responsive Design**: Full mobile layout optimization
- [ ] **Touch Interactions**: Native-feeling touch responses
- [ ] **Gesture Support**: Swipe navigation where appropriate
- [ ] **Viewport Management**: Proper viewport meta tag handling
- [ ] **Performance**: Mobile-optimized rendering and navigation

### Progressive Enhancement
- [ ] **JavaScript Disabled**: Basic navigation works without JS
- [ ] **Slow Networks**: Progressive loading with meaningful feedback
- [ ] **Offline Support**: Basic functionality during network outages
- [ ] **Legacy Browsers**: Graceful degradation for older browsers

## Acceptance Criteria
- [ ] All entry points successfully navigate to participants overview
- [ ] Return navigation works from all states and preserves context
- [ ] View action buttons only appear for appropriately revealed participants
- [ ] Mobile navigation is fully functional with touch interactions
- [ ] URL routing handles direct access and browser navigation correctly
- [ ] Error states provide clear user feedback and recovery options
- [ ] Accessibility features work with assistive technologies
- [ ] Performance remains smooth during navigation transitions

## Test Cases
1. **Entry Navigation**: Test all entry points to participants overview
2. **Return Navigation**: Test return to canvas from various states
3. **View Actions**: Test view buttons for revealed/non-revealed participants
4. **URL Handling**: Direct URL access and browser back/forward
5. **Mobile Navigation**: Touch interactions and responsive behavior
6. **Error Recovery**: Network failures and invalid session handling
7. **Accessibility**: Screen reader and keyboard navigation
8. **Performance**: Navigation speed and transition smoothness

## Dependencies
- 04.2.1 Header Integration (primary entry point)
- 04.2.2 Participant Cards (UI components)
- 04.2.3 Real-time Sync (participant data)
- Next.js router and session management
- 04.4 Viewer Mode (navigation target)

## Integration Points
- **Previous Sub-specs**: Complete integration of all previous sub-specs
- **Next Feature**: 04.3 Reveal Mechanism (enables view buttons)
- **Viewer Mode**: 04.4 Viewer Mode (navigation target for view actions)
- **Session System**: Authentication and session validation

## Status: ðŸ”´ Not Started

**Implementation Priority**: High - Completes participants overview feature  
**Estimated Complexity**: Medium - Navigation logic with error handling  
**UX Dependencies**: Navigation patterns, mobile interaction design