# Feature Spec: 04.3 - Reveal Mechanism

## Overview
Allow participants to share their Top 8 or Top 3 card selections with others, enabling discussion and comparison of leadership values.

## User Story
As a participant, I can choose to reveal my card selections to others in the session and view their revealed selections for discussion and insights.

## Technical Requirements

### Reveal Actions
- [ ] **"üëÅ Reveal" Button**: Available on Top 8 and Top 3 review screens
- [ ] **Confirmation Dialog**: "Share your selection with the group?"
- [ ] **Reveal Status**: Track whether Top 8 or Top 3 is revealed per participant
- [ ] **Public/Private Toggle**: Option to make selection visible to group
- [ ] **Live Updates**: Revealed arrangements update in real-time as owner moves cards

### Reveal States
```javascript
interface RevealState {
  participantId: string;
  sessionCode: string;
  revealType: 'top8' | 'top3';
  isRevealed: boolean;
  cardPositions: Array<{
    cardId: string;
    x: number;
    y: number;
    pile: string;
  }>;
  lastUpdated: number;
  viewerCount: number;
}
```

### Broadcasting System
- [ ] **Reveal Channel**: Dedicated channel for sharing card arrangements
- [ ] **Real-time Sync**: Live updates when revealed participant moves cards
- [ ] **Privacy Controls**: Only revealed arrangements are visible
- [ ] **Viewer Tracking**: Track who is viewing each revealed arrangement

### View Others' Selections
- [ ] **Participant List**: Show "See [Name]'s Top 8/3" buttons for revealed selections
- [ ] **Read-only View**: Full-screen display of participant's arrangement
- [ ] **Header Display**: "[Name]'s Top [8/3] Leadership Values"
- [ ] **Navigation**: "‚Üê Back to Participants" button
- [ ] **Viewer Presence**: Small avatars showing other active viewers

### Reveal UI Flow
- [ ] **Review Screen**: Reveal button appears with Snapshot and Next Step
- [ ] **Confirmation**: Clear dialog explaining what will be shared
- [ ] **Success Feedback**: "Your Top [8/3] values are now visible to the group"
- [ ] **Status Update**: Participant status changes to "revealed-8" or "revealed-3"
- [ ] **Button State**: Reveal button shows "üëÅ Revealed" when active

## Reveal System Implementation
```javascript
import { EventBus, EVENT_TYPES, createBaseEvent } from '@/lib/events';

class RevealManager {
  constructor(eventBus, sessionCode, participantId) {
    this.eventBus = eventBus;
    this.sessionCode = sessionCode;
    this.participantId = participantId;
    this.revealed = new Map(); // participantId -> RevealState
    this.viewers = new Map();   // participantId -> Set<viewerId>
    
    this.setupEventListeners();
  }
  
  async revealSelection(revealType, cardPositions) {
    const revealEvent = {
      ...createBaseEvent({
        type: EVENT_TYPES.SELECTION_REVEALED,
        sessionCode: this.sessionCode,
        participantId: this.participantId
      }),
      payload: {
        revealType,
        cardPositions,
        participantName: this.currentUser.name
      }
    };
    
    await this.eventBus.publishEvent(revealEvent);
  }
  
  async unrevealSelection(revealType) {
    const unrevealEvent = {
      ...createBaseEvent({
        type: EVENT_TYPES.SELECTION_UNREVEALED,
        sessionCode: this.sessionCode,
        participantId: this.participantId
      }),
      payload: {
        revealType,
        participantName: this.currentUser.name
      }
    };
    
    await this.eventBus.publishEvent(unrevealEvent);
  }
  
  async joinViewer(targetParticipantId) {
    const viewerEvent = {
      ...createBaseEvent({
        type: EVENT_TYPES.VIEWER_JOINED,
        sessionCode: this.sessionCode,
        participantId: this.participantId
      }),
      payload: {
        targetParticipantId,
        viewerName: this.currentUser.name
      }
    };
    
    await this.eventBus.publishEvent(viewerEvent);
  }
  
  setupEventListeners() {
    this.eventBus.subscribeToEventType(EVENT_TYPES.SELECTION_REVEALED, this.handleRevealEvent.bind(this));
    this.eventBus.subscribeToEventType(EVENT_TYPES.SELECTION_UNREVEALED, this.handleUnrevealEvent.bind(this));
    this.eventBus.subscribeToEventType(EVENT_TYPES.VIEWER_JOINED, this.handleViewerJoined.bind(this));
    this.eventBus.subscribeToEventType(EVENT_TYPES.VIEWER_LEFT, this.handleViewerLeft.bind(this));
    this.eventBus.subscribeToEventType(EVENT_TYPES.ARRANGEMENT_UPDATED, this.handleArrangementUpdate.bind(this));
  }
}
```

### Live Arrangement Updates
- [ ] **Real-time Sync**: Card movements broadcast to all viewers
- [ ] **Optimistic Updates**: Smooth updates for owner, synced to viewers
- [ ] **Position Debouncing**: Only sync final positions (200ms after drag ends)
- [ ] **Conflict Resolution**: Handle simultaneous updates gracefully
- [ ] **Update Indicators**: Show when participant is actively rearranging

### Privacy Features
- [ ] **Opt-in Reveal**: Participants explicitly choose to reveal
- [ ] **Granular Control**: Can reveal Top 8 but keep Top 3 private
- [ ] **Unrevel Option**: Ability to hide previously revealed selection
- [ ] **Viewer Awareness**: See who is viewing your revealed cards
- [ ] **Discussion Mode**: Revealed cards remain editable for real-time discussion

## Viewer Experience
```javascript
// Viewer state management using EventBus
class ViewerManager {
  constructor(eventBus, sessionCode, participantId) {
    this.eventBus = eventBus;
    this.sessionCode = sessionCode;
    this.participantId = participantId;
    this.currentView = null;
    this.revealed = new Map(); // Synced from reveal events
  }

  async enterViewMode(targetParticipantId) {
    const revealedData = this.revealed.get(targetParticipantId);
    if (!revealedData || !revealedData.isRevealed) {
      throw new Error('Participant has not revealed their selection');
    }
    
    this.currentView = {
      participantId: targetParticipantId,
      arrangement: revealedData.cardPositions,
      isReadOnly: true,
      lastUpdated: revealedData.lastUpdated
    };
    
    // Notify via EventBus that viewer joined
    const viewerEvent = {
      ...createBaseEvent({
        type: EVENT_TYPES.VIEWER_JOINED,
        sessionCode: this.sessionCode,
        participantId: this.participantId
      }),
      payload: {
        targetParticipantId,
        viewerName: this.currentUser.name
      }
    };
    
    await this.eventBus.publishEvent(viewerEvent);
  }
  
  async exitViewMode() {
    if (this.currentView) {
      // Notify via EventBus that viewer left
      const viewerLeftEvent = {
        ...createBaseEvent({
          type: EVENT_TYPES.VIEWER_LEFT,
          sessionCode: this.sessionCode,
          participantId: this.participantId
        }),
        payload: {
          targetParticipantId: this.currentView.participantId,
          viewerName: this.currentUser.name
        }
      };
      
      await this.eventBus.publishEvent(viewerLeftEvent);
      this.currentView = null;
    }
  }
}
```

### Viewer Presence
- [ ] **Avatar Display**: Small participant avatars in corner of viewed arrangement
- [ ] **Viewer Count**: Show number of people viewing
- [ ] **Hover Details**: Names of viewers on avatar hover
- [ ] **Join/Leave Animations**: Smooth transitions as viewers come and go
- [ ] **Maximum Display**: Show first 5 avatars, then "+3 others"

### Discussion Features
- [ ] **Live Editing**: Revealed arrangements can still be modified by owner
- [ ] **Visual Updates**: All viewers see changes in real-time
- [ ] **Cursor Tracking**: Show owner's cursor movements to viewers
- [ ] **Change Indicators**: Highlight recently moved cards
- [ ] **Activity Notifications**: Subtle indicators when owner is active

### Reveal Analytics
- [ ] **Reveal Rate**: Track percentage of participants who reveal
- [ ] **View Engagement**: Track who views whose selections
- [ ] **Discussion Time**: Measure time spent viewing others
- [ ] **Popular Values**: Aggregate most common values across reveals

## Event Types
- [ ] **SELECTION_REVEALED**: Participant shares their selection
- [ ] **SELECTION_UNREVEALED**: Participant hides their selection  
- [ ] **ARRANGEMENT_UPDATED**: Live card position updates
- [ ] **VIEWER_JOINED**: Someone starts viewing a reveal
- [ ] **VIEWER_LEFT**: Someone stops viewing a reveal

### Event Payloads
```typescript
interface SelectionRevealedEvent extends BaseEvent {
  type: typeof EVENT_TYPES.SELECTION_REVEALED;
  payload: {
    revealType: 'top8' | 'top3';
    cardPositions: Array<{
      cardId: string;
      x: number;
      y: number;
      pile: string;
    }>;
    participantName: string;
  };
}

interface ViewerJoinedEvent extends BaseEvent {
  type: typeof EVENT_TYPES.VIEWER_JOINED;
  payload: {
    targetParticipantId: string;
    viewerName: string;
  };
}

interface ArrangementUpdatedEvent extends BaseEvent {
  type: typeof EVENT_TYPES.ARRANGEMENT_UPDATED;
  payload: {
    revealType: 'top8' | 'top3';
    cardPositions: Array<{
      cardId: string;
      x: number;
      y: number;
      pile: string;
    }>;
    participantName: string;
  };
}
```

### Error Handling
- [ ] **Reveal Failures**: Handle failed reveal attempts gracefully
- [ ] **Sync Errors**: Recover from arrangement sync failures
- [ ] **Viewer Conflicts**: Handle multiple viewers efficiently
- [ ] **Network Issues**: Queue updates during disconnection
- [ ] **Invalid States**: Validate reveal data integrity

### Performance Considerations
- [ ] **Efficient Updates**: Only sync changed card positions
- [ ] **Viewer Limits**: Handle large numbers of viewers gracefully
- [ ] **Memory Management**: Clean up viewer data on disconnect
- [ ] **Network Optimization**: Compress large arrangement updates

## Security & Privacy
- [ ] **Access Control**: Only session participants can view reveals
- [ ] **Data Validation**: Validate all reveal messages
- [ ] **Session Isolation**: Reveals contained within session boundaries
- [ ] **Cleanup**: Remove reveal data when session ends

### Accessibility
- [ ] **Screen Reader**: Announce reveal status changes
- [ ] **Keyboard Navigation**: Navigate between revealed arrangements
- [ ] **High Contrast**: Ensure reveal indicators are visible
- [ ] **Focus Management**: Proper focus handling in view mode

## UI Components
```jsx
// Reveal button component
function RevealButton({ step, onReveal, isRevealed }) {
  return (
    <button 
      className={`reveal-btn ${isRevealed ? 'revealed' : ''}`}
      onClick={() => onReveal(step)}
      disabled={isRevealed}
    >
      {isRevealed ? 'üëÅ Revealed' : 'üëÅ Reveal'}
    </button>
  );
}

// Participant card in list
function ParticipantCard({ participant }) {
  const canViewTop8 = participant.revealed?.top8;
  const canViewTop3 = participant.revealed?.top3;
  
  return (
    <div className="participant-card">
      <div className="participant-info">
        {participant.emoji} {participant.name}
      </div>
      <div className="participant-status">
        {participant.status}
      </div>
      {canViewTop8 && (
        <button onClick={() => viewParticipant(participant.id, 'top8')}>
          See {participant.name}'s Top 8
        </button>
      )}
      {canViewTop3 && (
        <button onClick={() => viewParticipant(participant.id, 'top3')}>
          See {participant.name}'s Top 3
        </button>
      )}
    </div>
  );
}
```

## Acceptance Criteria
- [ ] Participants can reveal their Top 8 or Top 3 selections
- [ ] Revealed selections appear in participant list with view buttons
- [ ] Current user cannot view their own reveals (self-view exclusion)
- [ ] First-time reveal shows educational modal explaining functionality
- [ ] Education modal appears only once per session per user
- [ ] Toast notification appears when reveal button becomes available (threshold reached)
- [ ] Toast shows contextually near reveal button with "share your selection" message
- [ ] Toast appears only first time per step when threshold is reached
- [ ] Toast auto-dismisses after 4-5 seconds with smooth animation
- [ ] Full-screen viewer shows read-only arrangement correctly
- [ ] Live updates sync to all viewers when owner moves cards
- [ ] Viewer presence shows who is currently viewing
- [ ] Privacy controls work properly (opt-in reveal)
- [ ] Performance remains smooth with multiple viewers
- [ ] Error states handled gracefully

## Test Cases
1. Reveal Top 8 selection and verify it appears to others
2. View another participant's revealed selection
3. Verify current user cannot see "View" button for their own reveal (self-view exclusion)
4. First reveal attempt shows education modal explaining functionality
5. Education modal does not appear on subsequent reveals in same session
6. Education modal reappears in new session
7. Toast appears when reaching 8 cards in Step2 Most Important pile
8. Toast appears when reaching 3 cards in Step3 Most Important pile
9. Toast shows only once per step (first threshold crossing)
10. Toast auto-dismisses after 4-5 seconds
11. Toast can be manually dismissed early
12. Toast positioning near reveal button (contextual)
13. Test live arrangement updates while being viewed
14. Verify viewer presence indicators and avatars
15. Test reveal/unreveal functionality
16. Multiple viewers viewing same arrangement simultaneously
17. Network disconnection during reveal/view operations
18. Privacy controls (revealed vs private selections)
19. Load test with maximum participants revealing
20. Accessibility testing with screen readers

## Dependencies
- 04.1 Ably Setup ‚úì
- 04.2 Participants Overview ‚úì  
- 02-core-flow (review screens) ‚úì
- Event-driven architecture (EventBus, event types, validation) ‚úì
- Session-scoped store patterns ‚úì
- EventDrivenSessionContext ‚úì

## Status: üü¢ Complete

### ‚úÖ Implementation Completed: September 2, 2025

All acceptance criteria have been successfully implemented with comprehensive testing and runtime error resolution:

#### **Core Reveal System**:
- ‚úÖ Reveal button available on Top 8 and Top 3 review screens
- ‚úÖ Education modal for first-time reveal attempts (session-scoped)
- ‚úÖ Toast notifications when reveal button becomes available (contextual positioning)
- ‚úÖ Complete reveal state management with real-time synchronization
- ‚úÖ Viewer experience with participant list and "View" buttons
- ‚úÖ Self-view exclusion (current user cannot view own reveals)

#### **Technical Implementation**:
- ‚úÖ Complete component system: RevealButton, RevealButtonToast, RevealEducationModal, RevealConfirmationModal
- ‚úÖ Session-scoped hooks: useRevealEducation, useRevealToast, useRevealManager
- ‚úÖ Event-driven architecture integration with EventDrivenSessionContext
- ‚úÖ Real-time reveal state synchronization via Ably WebSockets
- ‚úÖ Comprehensive test coverage (unit, integration, E2E)

#### **Runtime Error Fixes**:
- ‚úÖ React import missing in Step2Page.tsx resolved
- ‚úÖ SessionHeader forwardRef syntax corrected
- ‚úÖ Lucide-react dependency installed for UI icons
- ‚úÖ Presence leave event handler added for proper cleanup
- ‚úÖ Reveal button persistence after reveal state achieved
- ‚úÖ Toast positioning aligned with Reveal button

#### **User Experience Features**:
- ‚úÖ Toast appears only once per step when threshold reached
- ‚úÖ Toast auto-dismisses after 4 seconds with smooth animations
- ‚úÖ Education modal appears only once per session per user
- ‚úÖ Reveal button shows current state (Reveal/Revealed)
- ‚úÖ Live updates when revealed participant moves cards
- ‚úÖ Privacy controls with opt-in reveal functionality

**Files Modified**: 36 files with 4,939 insertions, 2,351 deletions
**Production Status**: ‚úÖ Ready for production deployment
**Dependencies**: All resolved (04.1 Ably Setup, 04.2 Participants Overview, Event-driven architecture)

## Status: üü¢ Complete