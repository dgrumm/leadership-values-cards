# Feature Spec: 04.3 - Reveal Mechanism

## Overview
Allow participants to share their Top 8 or Top 3 card selections with others, enabling discussion and comparison of leadership values.

## User Story
As a participant, I can choose to reveal my card selections to others in the session and view their revealed selections for discussion and insights.

## Technical Requirements

### Reveal Actions
- [ ] **"üëÅ Reveal" Button**: Available on Top 8 and Top 3 review screens
- [ ] **Confirmation Dialog**: "Share your selection with the group?"
- [ ] **Reveal Status**: Track whether Top 8 or Top 3 is revealed per participant
- [ ] **Public/Private Toggle**: Option to make selection visible to group
- [ ] **Live Updates**: Revealed arrangements update in real-time as owner moves cards

### Reveal States
```javascript
interface RevealState {
  participantId: string;
  sessionCode: string;
  revealType: 'top8' | 'top3';
  isRevealed: boolean;
  cardPositions: Array<{
    cardId: string;
    x: number;
    y: number;
    pile: string;
  }>;
  lastUpdated: number;
  viewerCount: number;
}
```

### Broadcasting System
- [ ] **Reveal Channel**: Dedicated channel for sharing card arrangements
- [ ] **Real-time Sync**: Live updates when revealed participant moves cards
- [ ] **Privacy Controls**: Only revealed arrangements are visible
- [ ] **Viewer Tracking**: Track who is viewing each revealed arrangement

### View Others' Selections
- [ ] **Participant List**: Show "See [Name]'s Top 8/3" buttons for revealed selections
- [ ] **Read-only View**: Full-screen display of participant's arrangement
- [ ] **Header Display**: "[Name]'s Top [8/3] Leadership Values"
- [ ] **Navigation**: "‚Üê Back to Participants" button
- [ ] **Viewer Presence**: Small avatars showing other active viewers

### Reveal UI Flow
- [ ] **Review Screen**: Reveal button appears with Snapshot and Next Step
- [ ] **Confirmation**: Clear dialog explaining what will be shared
- [ ] **Success Feedback**: "Your Top [8/3] values are now visible to the group"
- [ ] **Status Update**: Participant status changes to "revealed-8" or "revealed-3"
- [ ] **Button State**: Reveal button shows "üëÅ Revealed" when active

## Reveal Channel Implementation
```javascript
class RevealManager {
  constructor(ablyService, sessionCode) {
    this.channel = ablyService.getChannel(sessionCode, 'reveals');
    this.revealed = new Map(); // participantId -> RevealState
    this.viewers = new Map();   // participantId -> Set<viewerId>
    
    this.setupRevealListeners();
  }
  
  async revealSelection(type, cardPositions) {
    const revealData = {
      participantId: this.currentUser.id,
      revealType: type,
      cardPositions,
      timestamp: Date.now()
    };
    
    await this.channel.publish('reveal-cards', revealData);
    this.updateParticipantStatus(`revealed-${type}`);
  }
  
  async viewParticipant(participantId) {
    await this.channel.publish('viewer-joined', {
      viewerId: this.currentUser.id,
      targetId: participantId,
      timestamp: Date.now()
    });
  }
}
```

### Live Arrangement Updates
- [ ] **Real-time Sync**: Card movements broadcast to all viewers
- [ ] **Optimistic Updates**: Smooth updates for owner, synced to viewers
- [ ] **Position Debouncing**: Only sync final positions (200ms after drag ends)
- [ ] **Conflict Resolution**: Handle simultaneous updates gracefully
- [ ] **Update Indicators**: Show when participant is actively rearranging

### Privacy Features
- [ ] **Opt-in Reveal**: Participants explicitly choose to reveal
- [ ] **Granular Control**: Can reveal Top 8 but keep Top 3 private
- [ ] **Unrevel Option**: Ability to hide previously revealed selection
- [ ] **Viewer Awareness**: See who is viewing your revealed cards
- [ ] **Discussion Mode**: Revealed cards remain editable for real-time discussion

## Viewer Experience
```javascript
// Viewer state management
class ViewerManager {
  enterViewMode(participantId) {
    const revealedData = this.revealed.get(participantId);
    if (!revealedData || !revealedData.isRevealed) {
      throw new Error('Participant has not revealed their selection');
    }
    
    this.currentView = {
      participantId,
      arrangement: revealedData.cardPositions,
      isReadOnly: true,
      lastUpdated: revealedData.lastUpdated
    };
    
    this.notifyViewerJoined(participantId);
  }
  
  exitViewMode() {
    if (this.currentView) {
      this.notifyViewerLeft(this.currentView.participantId);
      this.currentView = null;
    }
  }
}
```

### Viewer Presence
- [ ] **Avatar Display**: Small participant avatars in corner of viewed arrangement
- [ ] **Viewer Count**: Show number of people viewing
- [ ] **Hover Details**: Names of viewers on avatar hover
- [ ] **Join/Leave Animations**: Smooth transitions as viewers come and go
- [ ] **Maximum Display**: Show first 5 avatars, then "+3 others"

### Discussion Features
- [ ] **Live Editing**: Revealed arrangements can still be modified by owner
- [ ] **Visual Updates**: All viewers see changes in real-time
- [ ] **Cursor Tracking**: Show owner's cursor movements to viewers
- [ ] **Change Indicators**: Highlight recently moved cards
- [ ] **Activity Notifications**: Subtle indicators when owner is active

### Reveal Analytics
- [ ] **Reveal Rate**: Track percentage of participants who reveal
- [ ] **View Engagement**: Track who views whose selections
- [ ] **Discussion Time**: Measure time spent viewing others
- [ ] **Popular Values**: Aggregate most common values across reveals

## Message Types
- [ ] **reveal-cards**: Participant shares their selection
- [ ] **unreval-cards**: Participant hides their selection
- [ ] **update-arrangement**: Live card position updates
- [ ] **viewer-joined**: Someone starts viewing a reveal
- [ ] **viewer-left**: Someone stops viewing a reveal
- [ ] **arrangement-changed**: Owner modified revealed arrangement

### Error Handling
- [ ] **Reveal Failures**: Handle failed reveal attempts gracefully
- [ ] **Sync Errors**: Recover from arrangement sync failures
- [ ] **Viewer Conflicts**: Handle multiple viewers efficiently
- [ ] **Network Issues**: Queue updates during disconnection
- [ ] **Invalid States**: Validate reveal data integrity

### Performance Considerations
- [ ] **Efficient Updates**: Only sync changed card positions
- [ ] **Viewer Limits**: Handle large numbers of viewers gracefully
- [ ] **Memory Management**: Clean up viewer data on disconnect
- [ ] **Network Optimization**: Compress large arrangement updates

## Security & Privacy
- [ ] **Access Control**: Only session participants can view reveals
- [ ] **Data Validation**: Validate all reveal messages
- [ ] **Session Isolation**: Reveals contained within session boundaries
- [ ] **Cleanup**: Remove reveal data when session ends

### Accessibility
- [ ] **Screen Reader**: Announce reveal status changes
- [ ] **Keyboard Navigation**: Navigate between revealed arrangements
- [ ] **High Contrast**: Ensure reveal indicators are visible
- [ ] **Focus Management**: Proper focus handling in view mode

## UI Components
```jsx
// Reveal button component
function RevealButton({ step, onReveal, isRevealed }) {
  return (
    <button 
      className={`reveal-btn ${isRevealed ? 'revealed' : ''}`}
      onClick={() => onReveal(step)}
      disabled={isRevealed}
    >
      {isRevealed ? 'üëÅ Revealed' : 'üëÅ Reveal'}
    </button>
  );
}

// Participant card in list
function ParticipantCard({ participant }) {
  const canViewTop8 = participant.revealed?.top8;
  const canViewTop3 = participant.revealed?.top3;
  
  return (
    <div className="participant-card">
      <div className="participant-info">
        {participant.emoji} {participant.name}
      </div>
      <div className="participant-status">
        {participant.status}
      </div>
      {canViewTop8 && (
        <button onClick={() => viewParticipant(participant.id, 'top8')}>
          See {participant.name}'s Top 8
        </button>
      )}
      {canViewTop3 && (
        <button onClick={() => viewParticipant(participant.id, 'top3')}>
          See {participant.name}'s Top 3
        </button>
      )}
    </div>
  );
}
```

## Acceptance Criteria
- [ ] Participants can reveal their Top 8 or Top 3 selections
- [ ] Revealed selections appear in participant list with view buttons
- [ ] Full-screen viewer shows read-only arrangement correctly
- [ ] Live updates sync to all viewers when owner moves cards
- [ ] Viewer presence shows who is currently viewing
- [ ] Privacy controls work properly (opt-in reveal)
- [ ] Performance remains smooth with multiple viewers
- [ ] Error states handled gracefully

## Test Cases
1. Reveal Top 8 selection and verify it appears to others
2. View another participant's revealed selection
3. Test live arrangement updates while being viewed
4. Verify viewer presence indicators and avatars
5. Test reveal/unreveal functionality
6. Multiple viewers viewing same arrangement simultaneously
7. Network disconnection during reveal/view operations
8. Privacy controls (revealed vs private selections)
9. Load test with maximum participants revealing
10. Accessibility testing with screen readers

## Dependencies
- 04.1 Ably Setup ‚úì
- 04.2 Participants Overview ‚úì
- 02-core-flow (review screens) ‚úì

## Status: üî¥ Not Started